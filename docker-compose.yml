# CRITs Docker Compose - Development Stack
#
# Usage:
#   docker compose up              # Start all services
#   docker compose up -d           # Start in background
#   docker compose logs -f web     # Follow web logs
#   docker compose down            # Stop all services
#   docker compose down -v         # Stop and remove volumes
#
# First run:
#   CRITS_INIT_DB=true CRITS_ADMIN_USER=admin CRITS_ADMIN_PASSWORD=changeme docker compose up
#
# Access:
#   Django UI (legacy): http://localhost:8080
#   React UI (new): http://localhost:8080/app/
#   GraphQL API: http://localhost:8080/api/graphql
#   GraphiQL: http://localhost:8080/api/graphql (browser)

services:
  mongodb:
    image: mongo:7
    container_name: crits-mongodb
    restart: unless-stopped
    environment:
      - MONGO_INITDB_DATABASE=crits
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    # Internal only - other containers reach mongodb via service name
    expose:
      - "27017"

  redis:
    image: redis:7-alpine
    container_name: crits-redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Internal only - other containers reach redis via service name
    expose:
      - "6379"

  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
    container_name: crits-web
    restart: unless-stopped
    environment:
      # MongoDB connection
      - MONGO_HOST=mongodb
      - MONGO_PORT=27017
      - MONGO_DATABASE=crits
      # Redis connection (for sessions/caching)
      - REDIS_URL=redis://redis:6379/0
      # Django settings
      - DJANGO_SETTINGS_MODULE=crits.settings
      - DEBUG=${DEBUG:-true}
      # Security - CHANGE IN PRODUCTION
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      # API disabled by default (tastypie not installed)
      - ENABLE_API=false
      # Security settings for development (disable for HTTP access)
      - SECURE_SSL_REDIRECT=false
      - SECURE_COOKIES=false
      - SECURE_CROSS_ORIGIN_OPENER_POLICY=
      # CSRF trusted origins (add your host IP/domain here)
      - CSRF_TRUSTED_ORIGINS=${CSRF_TRUSTED_ORIGINS:-http://localhost:8080,http://localhost,http://127.0.0.1:8080,http://127.0.0.1,http://192.168.1.129:8080,http://192.168.1.129}
      # Database initialization (set to true on first run)
      - CRITS_INIT_DB=${CRITS_INIT_DB:-false}
      - CRITS_ADMIN_USER=${CRITS_ADMIN_USER:-}
      - CRITS_ADMIN_PASSWORD=${CRITS_ADMIN_PASSWORD:-}
      - CRITS_ADMIN_EMAIL=${CRITS_ADMIN_EMAIL:-}
    volumes:
      # Persist uploaded files and logs
      - crits_files:/app/files
      - crits_logs:/app/logs
    # No ports exposed directly - nginx proxies to us
    expose:
      - "8000"
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/login/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    container_name: crits-api
    restart: unless-stopped
    environment:
      # MongoDB connection
      - MONGO_HOST=mongodb
      - MONGO_PORT=27017
      - MONGO_DATABASE=crits
      # Redis connection (for sessions/caching)
      - REDIS_URL=redis://redis:6379/0
      # Django settings (for shared model imports)
      - DJANGO_SETTINGS_MODULE=crits.settings
      - DEBUG=${DEBUG:-true}
      # Security
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      # Cache settings
      - CACHE_DEFAULT_TTL=900
      - CACHE_ENABLED=true
      # GraphQL settings
      - GRAPHIQL_ENABLED=true
      # CORS - include common development hosts
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:8080,http://127.0.0.1:8080,http://192.168.1.129:8080}
    expose:
      - "8001"
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  ui:
    build:
      context: .
      dockerfile: docker/Dockerfile.ui
    container_name: crits-ui
    restart: unless-stopped
    expose:
      - "80"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  nginx:
    image: nginx:alpine
    container_name: crits-nginx
    restart: unless-stopped
    volumes:
      - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./extras/www:/app/extras/www:ro
    ports:
      - "8080:80"
    depends_on:
      - web
      - api
      - ui
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/login/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  mongodb_data:
    name: crits_mongodb_data
  crits_files:
    name: crits_files
  crits_logs:
    name: crits_logs
