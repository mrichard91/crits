# CRITs Web Application Dockerfile
# Usage: docker compose up
#
# This builds the Django web application for CRITs.

FROM python:3.12-slim-bookworm

LABEL maintainer="CRITs Development Team"
LABEL description="CRITs Django web application"

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Build essentials for compiling Python packages
    build-essential \
    gcc \
    g++ \
    # For cryptography package
    libffi-dev \
    libssl-dev \
    # For lxml package
    libxml2-dev \
    libxslt1-dev \
    # For Pillow package
    libjpeg-dev \
    zlib1g-dev \
    libpng-dev \
    # For python-magic
    libmagic1 \
    # For fuzzy hashing (pydeep, pyimpfuzzy)
    libfuzzy-dev \
    # General utilities
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install uv for fast package management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Set working directory
WORKDIR /app

# Copy project files
COPY pyproject.toml uv.lock ./
COPY crits/ ./crits/
COPY scripts/ ./scripts/
COPY extras/ ./extras/
COPY manage.py wsgi.py ./
COPY docker/entrypoint.sh /entrypoint.sh

# Install dependencies
RUN uv sync --frozen --extra fuzzy

# Make entrypoint executable
RUN chmod +x /entrypoint.sh

# Collect static files
RUN mkdir -p /app/static

# Expose port
EXPOSE 8000

# Set entrypoint
ENTRYPOINT ["/entrypoint.sh"]

# Default command: run gunicorn
CMD ["uv", "run", "gunicorn", "--bind", "0.0.0.0:8000", "--workers", "4", "--timeout", "120", "wsgi:application"]
